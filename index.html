<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a1f3a">
    <title>–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ –£–∫—Ä–∞—ó–Ω–∞</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="assets/icons/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è PWA */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body { 
            background: #0a1f3a; 
            color: white;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        /* –ú–∞–ø–∞ –∑–∞–π–º–∞—î –≤–µ—Å—å –µ–∫—Ä–∞–Ω */
        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
        }
        
        /* –•–µ–¥–µ—Ä –¥–ª—è PWA */
        .pwa-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: env(safe-area-inset-top, 20px) + 60px;
            padding-top: env(safe-area-inset-top, 20px);
            background: rgba(10, 31, 58, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: max(env(safe-area-inset-top, 20px), 20px) 15px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-title {
            flex: 1;
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-status {
            font-size: 12px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* –ö–æ–Ω—Ç—Ä–æ–ª–∏ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω—É */
        .mobile-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(10, 31, 58, 0.95), transparent);
            padding: 20px 15px max(env(safe-area-inset-bottom, 20px), 20px);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .mobile-btn {
            flex: 1;
            background: rgba(52, 152, 219, 0.9);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-height: 60px;
            backdrop-filter: blur(10px);
        }
        
        .mobile-btn-icon {
            font-size: 20px;
        }
        
        .mobile-btn-text {
            font-size: 11px;
        }
        
        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä */
        .status-bar {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 60px);
            left: 0;
            right: 0;
            background: rgba(231, 76, 60, 0.9);
            padding: 10px 15px;
            z-index: 999;
            display: none;
        }
        
        .status-bar.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* –ü–∞–Ω–µ–ª—å —Ç—Ä–∏–≤–æ–≥ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ */
        .mobile-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a1f3a;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        .mobile-panel.active {
            transform: translateY(0);
        }
        
        .panel-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a1f3a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (min-width: 768px) {
            .mobile-controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- –ú–∞–ø–∞ -->
    <div id="map"></div>
    
    <!-- PWA –•–µ–¥–µ—Ä -->
    <div class="pwa-header">
        <div class="header-title">üõ°Ô∏è –¢—Ä–∏–≤–æ–≥–∏ –£–∫—Ä–∞—ó–Ω–∏</div>
        <div class="header-status">
            <span id="status-icon">üî¥</span>
            <span id="status-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å -->
    <div id="alert-bar" class="status-bar">
        <div id="alert-text">–ù–æ–≤–∞ –ø–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞!</div>
    </div>
    
    <!-- –ú–æ–±—ñ–ª—å–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª–∏ -->
    <div class="mobile-controls">
        <button class="mobile-btn" id="btn-alerts">
            <span class="mobile-btn-icon">üì¢</span>
            <span class="mobile-btn-text">–¢—Ä–∏–≤–æ–≥–∏</span>
        </button>
        <button class="mobile-btn" id="btn-center">
            <span class="mobile-btn-icon">üéØ</span>
            <span class="mobile-btn-text">–¶–µ–Ω—Ç—Ä</span>
        </button>
        <button class="mobile-btn" id="btn-location">
            <span class="mobile-btn-icon">üìç</span>
            <span class="mobile-btn-text">–ú–æ—î –º—ñ—Å—Ü–µ</span>
        </button>
        <button class="mobile-btn" id="btn-settings">
            <span class="mobile-btn-icon">‚öôÔ∏è</span>
            <span class="mobile-btn-text">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
        </button>
    </div>
    
    <!-- –ú–æ–±—ñ–ª—å–Ω–∞ –ø–∞–Ω–µ–ª—å —Ç—Ä–∏–≤–æ–≥ -->
    <div id="mobile-panel" class="mobile-panel">
        <div class="panel-header">
            <h3>üì¢ –ê–∫—Ç–∏–≤–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏</h3>
            <button id="btn-close-panel">‚úñÔ∏è</button>
        </div>
        <div id="alerts-list">
            <!-- –¢—Ä–∏–≤–æ–≥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —Ç—É—Ç -->
        </div>
    </div>
    
    <!-- –ï–∫—Ä–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading-screen">
        <div style="font-size: 60px; margin-bottom: 20px;">üõ°Ô∏è</div>
        <h2 style="margin-bottom: 10px; text-align: center;">–ü–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏ –£–∫—Ä–∞—ó–Ω–∏</h2>
        <p style="opacity: 0.8; margin-bottom: 30px; text-align: center;">PWA –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É</p>
        <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s;"></div>
        </div>
        <p id="loading-text" style="margin-top: 10px; font-size: 14px; opacity: 0.7;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>
    
    <!-- –°–∫—Ä–∏–ø—Ç–∏ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        // –ë–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è PWA
        import { initMap } from './src/map/mapInit.js';
        import { initHUD, updateHUD } from './src/ui/hud.js';
        import { showNotification } from './src/ui/notifications.js';
        import { fetchRealAlerts } from './src/net/api.js';
        
        class MobileAirAlertApp {
            constructor() {
                this.map = null;
                this.activeAlerts = [];
                this.updateInterval = null;
            }
            
            async init() {
                try {
                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–ø–∏
                    this.map = initMap();
                    
                    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–∞–ø–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ
                    this.map.touchZoom.enable();
                    this.map.doubleClickZoom.disable();
                    
                    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –µ–∫—Ä–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                    setTimeout(() => {
                        this.hideLoading();
                    }, 1000);
                    
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
                    await this.loadAlerts();
                    
                    // –ó–∞–ø—É—Å–∫ –æ–Ω–æ–≤–ª–µ–Ω—å
                    this.startUpdates();
                    
                    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π
                    this.setupEvents();
                    
                    // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è PWA
                    this.registerPWA();
                    
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:', error);
                    showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É', 'error');
                }
            }
            
            async loadAlerts() {
                try {
                    const data = await fetchRealAlerts();
                    this.activeAlerts = data.states || [];
                    this.updateUI();
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—Ä–∏–≤–æ–≥:', error);
                }
            }
            
            updateUI() {
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
                const statusIcon = document.getElementById('status-icon');
                const statusText = document.getElementById('status-text');
                
                if (this.activeAlerts.length > 0) {
                    statusIcon.textContent = 'üî¥';
                    statusText.textContent = `${this.activeAlerts.length} –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥`;
                    document.getElementById('alert-bar').classList.add('active');
                    document.getElementById('alert-text').textContent = 
                        `–ê–∫—Ç–∏–≤–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏: ${this.activeAlerts.length}`;
                } else {
                    statusIcon.textContent = 'üü¢';
                    statusText.textContent = '–¢—Ä–∏–≤–æ–≥ –Ω–µ–º–∞—î';
                    document.getElementById('alert-bar').classList.remove('active');
                }
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ç—Ä–∏–≤–æ–≥
                this.updateAlertsList();
            }
            
            updateAlertsList() {
                const list = document.getElementById('alerts-list');
                if (!list) return;
                
                if (this.activeAlerts.length === 0) {
                    list.innerHTML = `
                        <div style="padding: 40px 20px; text-align: center; opacity: 0.7;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üïäÔ∏è</div>
                            <div>–¢—Ä–∏–≤–æ–≥ –Ω–µ–º–∞—î</div>
                            <div style="font-size: 12px; margin-top: 5px;">–£—Å—ñ —Ä–µ–≥—ñ–æ–Ω–∏ –±–µ–∑–ø–µ—á–Ω—ñ</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                this.activeAlerts.forEach(alert => {
                    html += `
                        <div class="alert-item">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                üö® ${alert.name || alert.region}
                            </div>
                            <div style="font-size: 12px; opacity: 0.8;">
                                ${new Date(alert.changed).toLocaleTimeString('uk-UA')}
                            </div>
                        </div>
                    `;
                });
                
                list.innerHTML = html;
            }
            
            startUpdates() {
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
                this.updateInterval = setInterval(() => {
                    this.loadAlerts();
                }, 30000);
            }
            
            setupEvents() {
                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('btn-alerts').addEventListener('click', () => {
                    document.getElementById('mobile-panel').classList.add('active');
                });
                
                document.getElementById('btn-close-panel').addEventListener('click', () => {
                    document.getElementById('mobile-panel').classList.remove('active');
                });
                
                document.getElementById('btn-center').addEventListener('click', () => {
                    this.map.setView([49.0, 31.5], 6);
                });
                
                document.getElementById('btn-location').addEventListener('click', () => {
                    this.getUserLocation();
                });
                
                document.getElementById('btn-settings').addEventListener('click', () => {
                    showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—É–¥—É—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ñ –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ', 'info');
                });
                
                // Swipe –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–∞–Ω–µ–ª—ñ
                let startY;
                const panel = document.getElementById('mobile-panel');
                
                panel.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                });
                
                panel.addEventListener('touchmove', (e) => {
                    const currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    if (diff > 50) {
                        panel.classList.remove('active');
                    }
                });
            }
            
            async getUserLocation() {
                if (!navigator.geolocation) {
                    showNotification('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è', 'error');
                    return;
                }
                
                showNotification('–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è...', 'info');
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000
                        });
                    });
                    
                    const { latitude, longitude } = position.coords;
                    this.map.setView([latitude, longitude], 13);
                    showNotification('–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤–∏–∑–Ω–∞—á–µ–Ω–æ', 'success');
                    
                } catch (error) {
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è', 'error');
                }
            }
            
            registerPWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(() => console.log('Service Worker –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ'))
                        .catch(err => console.log('–ü–æ–º–∏–ª–∫–∞ Service Worker:', err));
                }
                
                // –ö–Ω–æ–ø–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // –ú–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
                    setTimeout(() => {
                        if (deferredPrompt && confirm('–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫ –Ω–∞ —Ä–æ–±–æ—á–∏–π —Å—Ç—ñ–ª?')) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then(() => {
                                deferredPrompt = null;
                            });
                        }
                    }, 3000);
                });
            }
            
            hideLoading() {
                const loading = document.getElementById('loading-screen');
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
        const app = new MobileAirAlertApp();
        window.addEventListener('DOMContentLoaded', () => app.init());
        window.app = app;
    </script>
</body>
                </html>
